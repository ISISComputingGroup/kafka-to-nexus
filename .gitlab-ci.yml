default:
  tags:
    - docker

stages:
  - checks
  - build
  - test
  - release

.checks:
  stage: checks
  image: registry.esss.lu.se/ecdc/ess-dmsc/docker-ubuntu2204-build-node:latest

clang-format:
  extends: .checks
  script:
    - ci/check-formatting.sh

black:
  extends: .checks
  script:
    - python3 -m black --version
    - python3 -m black --check integration-tests

cppcheck:
  extends: .checks
  script:
    - cppcheck --version
    - >
      cppcheck \
        --xml \
        --inline-suppr \
        --suppress=unusedFunction \
        --suppress=missingInclude \
        --enable=all \
        --inconclusive \
        src/ 2> cppcheck.xml
  only:
    - merge_requests

build-debug:
  stage: build
  image: registry.esss.lu.se/ecdc/ess-dmsc/docker-centos7-build-node:latest
  script:
    - mkdir build
    - cd build
    - scl enable devtoolset-11 rh-python38 -- conan install --build missing ..
    - >
      scl enable devtoolset-11 rh-python38 -- cmake \
        -GNinja \
        -DCMAKE_BUILD_TYPE=Debug \
        -DCONAN=MANUAL \
        -DRUN_DOXYGEN=ON \
        -DCOV=ON \
        ..
    - scl enable devtoolset-11 rh-python38 -- ninja all UnitTests docs
  artifacts:
    paths:
      - build/bin/
      - build/lib/
      - build/licenses/

build-release:
  stage: build
  image: registry.esss.lu.se/ecdc/ess-dmsc/docker-centos7-build-node:latest
  script:
    - mkdir build
    - cd build
    - scl enable devtoolset-11 rh-python38 -- conan install --build missing ..
    - scl enable devtoolset-11 rh-python38 -- ../ci/configure-release.sh .. .
    - scl enable devtoolset-11 rh-python38 -- ninja all UnitTests docs
    - ./bin/UnitTests
  artifacts:
    paths:
      - build/bin/
      - build/lib/
      - build/licenses/

test-debug:
  stage: test
  image: registry.esss.lu.se/ecdc/ess-dmsc/docker-centos7-build-node:latest
  script:
    - cd build
    - ninja coverage
    - cat coverage.txt
  coverage: '/^TOTAL.*\s+(\d+\%)$/'
  artifacts:
    paths:
      - build/coverage.xml
    reports:
      coverage_report:
        coverage_format: cobertura
        path: build/coverage.xml
  dependencies:
    - build-debug

test-release:
  stage: test
  image: registry.esss.lu.se/ecdc/ess-dmsc/docker-centos7-build-node:latest
  script:
    - cd build
    - ./bin/UnitTests --gtest_output=xml:test-output.xml
  artifacts:
    paths:
      - build/test-output.xml
    reports:
      junit: build/test-output.xml
  dependencies:
    - build-release
